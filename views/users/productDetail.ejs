<%- include("../layouts/user/header") -%>

<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="/home" rel="nofollow">Home</a>
                <span></span><a href="/shop">shop</a> 
                <span></span> Product Detail 
            </div>
        </div>
    </div>
    <section class="mt-50 mb-50">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="product-detail accordion-detail">
                        <div class="row mb-50">
                            <div class="col-md-6 col-sm-12 col-xs-12">
                                <div class="detail-gallery">
                                    <span class="zoom-icon"><i class="fi-rs-search"></i></span>
                                    <div class="product-image-slider">
                                        <figure class="border-radius-10">
                                            <!-- Main Slide -->
                                            <% if (products.image.length > 0) { %>
                                                <img id="mainSlide" src="/assets/uploads/<%= products.image[0].filename %>" alt="Main Slide" class="zoom" style="width: 620px; height: 575px;">
                                            <% } %>      
                                        </figure>
                                    </div>

                                    <!-- THUMBNAILS -->
                                    <div class="slider-nav-thumbnails pl-15 pr-15" style="display: flex; flex-direction: row; overflow-x: auto;">
                                        <% products.image.forEach((image, index) => { %>
                                            <div class="thumbnail" onclick="changeMainSlide('<%= image.filename %>')" style="margin-right: 10px;">
                                                <img src="/assets/uploads/<%= image.filename %>" alt="Thumbnail <%= index + 1 %>" style="width: 100px; height: 100px;">
                                            </div>
                                        <% }) %>
                                    </div>
                                </div>
                                <!-- End Gallery -->
                            </div>
                            <body>
                                <div class="col-md-6 col-sm-12 col-xs-12">
                                    <div class="detail-info">
                                        <h2 class="title-detail"><%= products.productName %></h2>
                                        <div class="product-detail-rating">
                                            <div class="pro-details-brand">
                                                <span> Brands: <a> Spacewood</a></span>
                                            </div>
                                            <div class="product-rate-cover text-end">
                                                <div class="product-rate d-inline-block">
                                                    <div class="product-rating" style="width:90%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="clearfix product-price-cover">
                                            <div class="product-price primary-color float-left">
                                                <ins><span class="text-brand">Rs. <%= products.salePrice %></span></ins>
                                                <ins><span class="old-price font-md ml-15">Rs. <%= products.regularPrice %></span></ins>
                                            </div>
                                        </div>
                                        <div class="bt-1 border-color-1 mt-15 mb-15"></div>
                                        <div class="short-desc mb-30">
                                            <p><%= products.description %></p>
                                        </div>
                                        <div class="product_sort_info font-xs mb-30">
                                            <ul>
                                                <li class="mb-10"><i class="fi-rs-crown mr-5"></i> 1 Year Brand Warranty</li>
                                                <li class="mb-10"><i class="fi-rs-refresh mr-5"></i> 30 Day Return Policy</li>
                                                <li><i class="fi-rs-credit-card mr-5"></i> Cash on Delivery available</li>
                                            </ul>
                                        </div>
                                        <div class="attr-detail attr-size">
                                            <strong class="mr-10">Size</strong>
                                            <ul class="list-filter size-filter font-small">
                                                <li><a href="#">S</a></li>
                                                <li class="active"><a href="#">M</a></li>
                                                <li><a href="#">L</a></li>
                                            </ul>
                                        </div>
                                        <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                                        <div class="detail-extralink">
                                            <form class="cart clearfix" id="addToCartForm" data-product-id="<%= products._id %>">
                                                <div class="cart-btn d-flex mb-50">
                                                
                                                    <div class="quantity">
                                                        <p>Qty</p>
                                                        <input
                                                            type="number"
                                                            class="qty-val"
                                                            id="qty"
                                                            step="1"
                                                            min="1"
                                                            max="300"
                                                            name="quantity"
                                                            value="1"
                                                            oninput="validateQuantity(this)"
                                                        />
                                                    </div>
                                                </div>
                                                
                                                                                
                                                <div class="product-extra-link2">
                                                    <% if (products.quantity < 1) { %>
                                                        <button type="button" class="button button-add-to-cart out-of-stock">Out Of Stock</button>
                                                    <% } else { %>
                                                        <button type="button" class="button button-add-to-cart" onclick="addToCartDetails('<%= products._id %>')">Add to cart</button>
                                                    <% } %>
                                                    <a aria-label="Add To Wishlist" class="action-btn hover-up" href="#" onclick="addTowishlist('<%= products._id %>')"><i class="fi-rs-heart"></i></a>
                                                    <a aria-label="Compare" class="action-btn hover-up" href="shop-compare.html"><i class="fi-rs-shuffle"></i></a>
                                                </div>
                                                </form>
                                                </div>
                                                <ul class="product-meta font-xs color-grey mt-50">
                                                    <li>
                                                        Availability:
                                                        <span class="<%= products.quantity < 1 ? 'text-danger' : 'text-success' %> ml-5">
                                                            <%= products.quantity %> Items In Stock
                                                        </span>
                                                    </li>
                                                </ul>
                                                
                                    </div>
                                </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-10 m-auto entry-main-content">
                                <h2 class="section-title style-1 mb-30">Description</h2>
                                <span class="wp-block-separator is-style-wide"><%= products.description %></span>
                                <div class="description mb-50">
                                    <hr class="wp-block-separator is-style-dots">
                                    <p>This product comes with a 12 months warranty against manufacturing defects. Fabrics, leatherettes and leathers, if used, will not be covered by the above Warranty. Only our Luxe range of fabrics will be covered under 36 months warranty.</p>
                                    <h4 class="mt-30">Packaging & Delivery</h4>
                                    <hr class="wp-block-separator is-style-wide">
                                    <p>Less lion goodness that euphemistically robin expeditiously bluebird smugly scratched far while thus cackled sheepishly rigid after due one assenting regarding censorious while occasional or this more crane went more as this less much amid overhung anathematic because much held one exuberantly sheep goodness so where rat wry well concomitantly.</p>
                                    <p>Scallop or far crud plain remarkably far by thus far iguana lewd precociously and and less rattlesnake contrary caustic wow this near alas and next and pled the yikes articulate about as less cackled dalmatian in much less well jeering for the thanks blindly sentimental whimpered less across objectively fanciful grimaced wildly some wow and rose jeepers outgrew lugubrious luridly irrationally attractively dachshund.</p>
                                </div>
                                
                                <div class="social-icons single-share">
                                    <ul class="text-grey-5 d-inline-block">
                                        <li><strong class="mr-10">Share this:</strong></li>
                                        <li class="social-facebook"><a href="#"><img src="assets/imgs/theme/icons/icon-facebook.svg" alt=""></a></li>
                                        <li class="social-twitter"> <a href="#"><img src="assets/imgs/theme/icons/icon-twitter.svg" alt=""></a></li>
                                        <li class="social-instagram"><a href="#"><img src="assets/imgs/theme/icons/icon-instagram.svg" alt=""></a></li>
                                        <li class="social-linkedin"><a href="#"><img src="assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a></li>
                                    </ul>
                                </div>
                                <h3 class="section-title style-1 mb-30 mt-30">Reviews (3)</h3>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<!-- Include Zooming JavaScript -->
<script src="https://unpkg.com/zooming/build/zooming.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>

<script>
    document.querySelectorAll('.qty-up').forEach(button => {
    button.addEventListener('click', function() {
        let qtyVal = this.previousElementSibling;
        qtyVal.textContent = parseInt(qtyVal.textContent) + 1;
    });
});

document.querySelectorAll('.qty-down').forEach(button => {
    button.addEventListener('click', function() {
        let qtyVal = this.nextElementSibling;
        if (parseInt(qtyVal.textContent) > 1) {
            qtyVal.textContent = parseInt(qtyVal.textContent) - 1;
        }
    });
});
    // Initialize Zooming
    const zooming = new Zooming({
        zIndex: 9999, // Ensure the zoomed image is on top of other elements
        scrollOffset: false, // Disable page scrolling when zooming
        enableGrab: true, // Allow grabbing the image to move around when zoomed
    });

    // Attach Zooming to your main image
    zooming.listen('.zoom');
</script>

<script>
    function changeMainSlide(filename) {
        document.getElementById('mainSlide').src = '/assets/uploads/' + filename;
        // Reinitialize the zoom on the new image
        zooming.destroy();
        zooming.listen('.zoom');
    }
</script>


    <script>
    
    const MAX_QUANTITY_PER_PERSON = 10;

function updateQuantity(action, productId, index) {
    let quantityInput = document.getElementById(`cartProductqty${index}`);
    let currentQuantity = parseInt(quantityInput.value);
    let newQuantity = action === 'qtyInc' ? currentQuantity + 1 : currentQuantity - 1;

    if (newQuantity < 1) {
        newQuantity = 1; // Ensure the quantity does not go below 1
    } else if (newQuantity > MAX_QUANTITY_PER_PERSON) {
        Swal.fire({
            title: 'Error!',
            text: `You cannot add more than ${MAX_QUANTITY_PER_PERSON} of this product to the cart.`,
            icon: 'error',
            confirmButtonText: 'OK'
        });
        return; // Exit the function to prevent updating the quantity
    }

    console.log(`Updating quantity for product ${productId} at index ${index}`);
    console.log(`Current Quantity: ${currentQuantity}, New Quantity: ${newQuantity}`);

    // Update the input field with the new quantity
    quantityInput.value = newQuantity;

    // Update the subtotal for the product
    let priceElement = document.getElementById(`price${index}`);
    let price = parseFloat(priceElement.innerText.replace('$', ''));
    let subtotalElement = document.getElementById(`subtotal${index}`);
    let newSubtotal = (price * newQuantity).toFixed(2);
    subtotalElement.innerText = `$${newSubtotal}`;

    console.log(`New Subtotal: ${newSubtotal}`);

    // Update the cart on the server side (optional, use AJAX/fetch to update the cart in the backend)
    fetch('/update-cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ productId: productId, quantity: newQuantity })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Cart updated', data);
        // Optionally update the total subtotal value if displayed
        // document.getElementById('totalSubTotal').innerText = `$${data.totalSubTotal.toFixed(2)}`;
    })
    .catch(error => {
        console.error('Error updating cart:', error);
    });
}

function validateQuantity(input) {
    let value = parseInt(input.value);
    if (value < 1) {
        input.value = 1;
    } else if (value > MAX_QUANTITY_PER_PERSON) {
        input.value = MAX_QUANTITY_PER_PERSON;
        Swal.fire({
            title: 'Error!',
            text: `You cannot add more than ${MAX_QUANTITY_PER_PERSON} of this product to the cart.`,
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}

function addTowishlist(productId) {
    
  console.log(productId);

  $.ajax({
    url: `/add-to-wishlist-icon?id=${productId}`,  // Check this URL
    type: "PUT",
    contentType: "application/json",
    data: JSON.stringify({ is_blocked: true }),
    success: function (response) {
      updateCartNumber(response.count);

      removeCartIcon(productId);
    },
    error: function (xhr, status, error) {
      console.error("Failed to add to wishlist", error);
    },
  });

  // Show SweetAlert at the center
  Swal.fire({
    position: "center",
    icon: "success",
    title: "Product added to wishlist!",
    showConfirmButton: false,
    timer: 1500,
  }).then(() => {
     window.location.reload(); // Reload the window
    });

}



function addToCartDetails(productId) {
    const qtyInput = document.getElementById('qty'); // Get the input field directly
    const qtyVal = parseInt(qtyInput.value); // Get the value of the input field as an integer
    console.log(qtyVal, 'quantity');


    fetch('/add-to-cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            productId: productId,
            quantity: qtyVal
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                title: 'Success!',
                text: 'Product Added Successfully',
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.href = '/add-to-cart';
            });
        } else {
            Swal.fire({
                title: 'Error!',
                text: data.message,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'Error!',
            text: 'An unexpected error occurred.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    });
}


document.querySelectorAll('.increment-button').forEach(button => {
    button.addEventListener('click', (event) => {
        event.preventDefault();
        const productId = button.getAttribute('data-product-id');
        const index = button.getAttribute('data-index');
        updateQuantity('qtyInc', productId, index);
    });
});

document.querySelectorAll('.decrement-button').forEach(button => {
    button.addEventListener('click', (event) => {
        event.preventDefault();
        const productId = button.getAttribute('data-product-id');
        const index = button.getAttribute('data-index');
        updateQuantity('qtyDec', productId, index);
    });
});

document.querySelector('.button-add-to-cart').addEventListener('click', (event) => {
    event.preventDefault();
    const productId = '<%= products._id %>';
    addToCartDetails(productId);
});



    </script>
    
<%- include("../layouts/user/footer") -%>